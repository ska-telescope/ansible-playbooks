- name: Add GitLab’s official repository
  shell: curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | sudo bash

- name: Install the latest version of GitLab Runner
  apt:
    name:
    - gitlab-runner
    - make
    update_cache: yes

- name: Tidy up Traefik tmp
  file:
    path: '/tmp/traefik-minikube.yaml'
    state: absent
  become: yes

- name: Add GitLab’s official repository
  shell: |
    gitlab-runner register \
      --non-interactive \
      --url "https://gitlab.com/" \
      --registration-token "{{token}}" \
      --executor "{{executor}}" \
      --docker-image {{docker_image}} \
      --description "{{name}}" \
      --tag-list "{{taglist}}" \
      --run-untagged="true" \
      --locked="false" \
      --access-level="not_protected"

# - name: Config.toml
#   template:
#     src: config.toml
#     dest: /etc/gitlab-runner/config.toml
#   when: executor == 'docker'

- name: Check that the service has already been installed
  stat:
    path: /etc/systemd/system/gitlab-runner.service
  register: stat_config

- name: Install GitLab runner service
  shell: |
    gitlab-runner install --user {{ansible_user}}
  when: stat_config.stat.exists == False

- name: Run GitLab runner service
  shell: |
    gitlab-runner start
